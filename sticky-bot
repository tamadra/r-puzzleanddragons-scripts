import praw
from datetime import datetime, timedelta
def ord(n):
    return str(n)+("th" if 4<=n%100<=20 else {1:"st",2:"nd",3:"rd"}.get(n%10, "th"))
START_TAG = '> [](#s1)';
END_TAG = '> [](#s1_)';

r = praw.Reddit(user_agent='/r/PuzzleAndDragons Sidebar Updater')
r.config.decode_html_entities = True
r.login('username', 'password')
pad = r.get_subreddit("puzzleanddragons")
current_sidebar = pad.get_settings()['description']
idx1 = current_sidebar.find(START_TAG)
idx2 = current_sidebar.find(END_TAG)

if idx1 < 0 or idx2 < 0:
    print "Not Found"
else:
    start_idx = idx1 + len(START_TAG);
    stickytext = current_sidebar[start_idx : idx2]    
    idx3 = stickytext.find('/comments/')
    if idx3 < 0:
        print "Not Found"
    else:
        previous_submission_id = stickytext[idx3+len('/comments/'):].split('/')[0]        
        submission = r.get_submission(submission_id = previous_submission_id)               
        previous_time = datetime.fromtimestamp(submission.created_utc)   
        now_time = datetime.now()
        hours_ago = (now_time - previous_time).days * 24 + (now_time - previous_time).seconds/3600
        if (hours_ago >= 25):
            future_date = now_time + timedelta(days=3)
            title = 'General Help & Discussion Thread.  '+now_time.strftime('%b')+" "+ord(now_time.day)+" - "+future_date.strftime('%b')+" "+ord(future_date.day)
            submit_result = r.submit('puzzleanddragons', title, text="###Post your questions or box help requests in this thread\n\n* Please use PadHerder to show your monster box.\n* Be specific with your questions so people have a better understanding of your needs.\n* Show some love for the people who took time to respond to your question; upvote any responses that were helpful.\n\nPrevious thread [here]("+submission.permalink+")")
            new_sidebar = current_sidebar[0:start_idx] + "\n> ## ["+title+"]("+submit_result.permalink+"?sort=new#icon-exclamation-red)  **Individual posts will be removed. Please use this thread instead.**\n" + current_sidebar[idx2:]            
            pad.update_settings(description=new_sidebar)
            print "New post created: "+submit_result.permalink
        else:
            print "Skipping. Less than 3 days"
